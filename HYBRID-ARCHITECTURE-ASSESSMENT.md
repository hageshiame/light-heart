# 混合架构重新评估：4核8G服务器 + 本地SQLite

> **新的架构决策**: 本地优先 + 服务端可选存储  
> **目标**: 单机可玩 + 部分功能服务端支持  
> **约束**: 4核8G服务器容量有限

**评估时间**: 2025-12-26  
**评估依据**: 原1953行implementation-guide.md + 所有技术决策文档

---

## 第一部分：4核8G服务器容量分析

### 1.1 服务器容量评估

```yaml
硬件规格:
  CPU: 4核 (阿里云等公有云标准配置)
  内存: 8GB
  磁盘: 通常50-100GB SSD
  带宽: 1-5Mbps (取决于ISP)
  
消耗预估:
  系统占用: 1.5GB (Linux OS + 必要服务)
  Java/Node.js运行时: 1.5GB
  MySQL数据库: 2GB (可配置)
  应用程序代码: 0.5GB
  缓存(Redis): 1GB
  日志与临时文件: 0.5GB
  ――――――――――――――
  可用容量: 剩余 1GB
  
真实可用比例: 仅88%
```

### 1.2 关键性能指标

| 指标 | 4核8G能力 | 你的需求 | 评估 |
|------|---------|--------|------|
| **并发用户** | 500-1000 | 日活100-500 | ✅ 足够 |
| **QPS(每秒请求数)** | 2000-3000 | 预计100-300 | ✅ 足够 |
| **存储容量** | 50GB磁盘 | 预计<10GB | ✅ 足够 |
| **响应时间** | 100-200ms | 需要<200ms | ⚠️ 勉强 |
| **热更新频率** | 可支持 | 预计1次/周 | ✅ 可以 |

**结论**: 4核8G足够微信小游戏的初期运营，但不能:
- ❌ 同时在线>2000人
- ❌ 每分钟>50000条写入操作
- ❌ 毫秒级响应时间

---

## 第二部分：架构现实可行性分析

### 2.1 原设计中哪些功能**必须**服务端

| 功能 | 原方案依赖 | 为什么必须服务端 | 本方案 |
|------|----------|----------------|-------|
| **排行榜** | ✅ 服务端计算 | 跨设备对比，防篡改 | **保留** ⭐️ |
| **救援机制** | ✅ 服务端同步 | A设备→服务端→B设备 | **保留** ⭐️ |
| **好友系统** | ✅ 服务端关联 | 微信openid匹配 | **简化** ⚠️ |
| **反作弊** | ✅ 服务端校验 | 验证战斗结果真实性 | **简化** ⚠️ |
| **热更新** | ✅ 服务端下发 | 配置改动无需发版 | **支持** ✅ |

### 2.2 原设计中哪些功能**完全可本地**

| 功能 | 说明 | 性能影响 |
|------|------|--------|
| **搜寻机制** | 地图生成+随机宝箱 (纯算法) | 无网络请求 ✅ |
| **战斗演算** | 伤害计算+AI决策 (离线计算) | 无网络请求 ✅ |
| **角色养成** | 升级、装备强化 (本地SQLite) | 异步定期上报 ✅ |
| **Spine动画** | 本地播放与控制 | 无网络请求 ✅ |
| **成就系统** | 本地判定与解锁 | 可选上报 ✅ |

### 2.3 需要修改的功能

| 功能 | 原设计 | 新方案改动 | 影响 |
|------|-------|----------|------|
| **排行榜计算** | 实时同步 | 异步计算 (5分钟更新一次) | 🟡 轻微延迟 |
| **救援数据** | 实时验证 | 异步验证 (玩家重新进入时检查) | 🟡 轻微延迟 |
| **反作弊检测** | 严格验证 | 宽松检查 (仅检查数值范围) | 🟡 作弊难度↑ |
| **热更新** | 立即生效 | 下次启动游戏时生效 | 🟡 需要重启 |

---

## 第三部分：建议方案（生产就绪）

### 3.1 核心架构设计

```
┌─────────────────────────────────┐
│       玩家手机端 (iOS/安卓)      │
├─────────────────────────────────┤
│  本地SQLite数据库                │
│  ├─ 角色与装备数据              │
│  ├─ 战斗记录                    │
│  ├─ 地图进度                    │
│  └─ 成就系统                    │
├─────────────────────────────────┤
│  游戏逻辑(离线可玩)              │
│  ├─ 搜寻算法                    │
│  ├─ 战斗演算                    │
│  ├─ 地图生成 (种子算法)         │
│  └─ 粒子特效                    │
├─────────────────────────────────┤
│  定期同步线程                    │
│  每5分钟 or 游戏暂停时同步:      │
│  ├─ 角色等级/装备               │
│  ├─ 战斗成绩                    │
│  └─ 成就进度                    │
└─────────────┬───────────────────┘
              │ 异步网络请求
              │ (WiFi或4G)
              ↓
┌─────────────────────────────────┐
│     4核8G服务器 (云)             │
├─────────────────────────────────┤
│  排行榜服务                      │
│  ├─ 接收玩家分数上报             │
│  ├─ 每5分钟重新计算排名          │
│  └─ Redis缓存排名结果            │
├─────────────────────────────────┤
│  救援数据交换                    │
│  ├─ A设备→上报失败信息           │
│  ├─ B设备→查询救援任务           │
│  └─ 验证→返还物品数据            │
├─────────────────────────────────┤
│  热更新配置中心                  │
│  ├─ 掉落率配置                  │
│  ├─ 怪物属性                    │
│  └─ 关卡参数                    │
├─────────────────────────────────┤
│  数据持久化 (MySQL)              │
│  ├─ 玩家账户表                  │
│  ├─ 排行榜历史                  │
│  ├─ 救援记录                    │
│  └─ 反作弊日志                  │
└─────────────────────────────────┘
```

### 3.2 数据同步策略 (关键)

```typescript
// 同步分层 (优先级递减)

Layer 1 - 关键数据 (实时同步, <2秒):
  ✓ 登录状态
  ✓ 新的排行榜成绩 (战斗胜利时)
  延迟容限: < 3秒
  失败处理: 本地缓存，下次尝试
  
Layer 2 - 重要数据 (准实时同步, <30秒):
  ✓ 救援求助上报 (仅在需要时)
  ✓ 热更新配置 (游戏启动时)
  延迟容限: < 1分钟
  缓存策略: 本地版本控制
  
Layer 3 - 辅助数据 (延迟同步, <5分钟):
  ✓ 角色等级/经验
  ✓ 装备数据
  ✓ 成就进度
  同步频率: 每5分钟 或 游戏暂停时
  冲突解决: 服务端版本优先
  
Layer 4 - 统计数据 (后台同步, <30分钟):
  ✓ 游戏时长统计
  ✓ 战斗统计数据
  ✓ 反作弊审计日志
  同步频率: 每30分钟 或 应用退出时
```

### 3.3 网络断线处理

```typescript
// 核心逻辑: 游戏完全离线可玩

class NetworkManager {
  async syncData(type: 'critical'|'important'|'auxiliary') {
    try {
      // 尝试同步
      const response = await fetch(API_URL, {
        timeout: 5000,  // 5秒超时
        retries: 3      // 最多重试3次
      });
      
      if (!response.ok) {
        throw new Error('Sync failed');
      }
      
      return response.json();
    } catch (error) {
      // 网络错误: 本地缓存继续玩
      console.warn(`Network error (${type}):`, error);
      
      if (type === 'critical') {
        // 关键数据失败: 保存待同步队列
        this.queueForRetry({
          data: lastData,
          timestamp: Date.now(),
          retryCount: 0
        });
      }
      
      // 返回本地缓存的上次结果
      return this.getLocalCache(type);
    }
  }
}

// 重连策略
class ReconnectionManager {
  private retryQueue: SyncTask[] = [];
  
  onNetworkRestored() {
    // 网络恢复: 按优先级逐个同步
    for (const task of this.retryQueue) {
      if (task.retryCount < 3) {
        this.syncData(task.data);
        task.retryCount++;
      }
    }
  }
}
```

---

## 第四部分：文档修改清单 (新版)

### 4.1 哪些文档**不需要**改动

| 文档 | 原因 |
|------|------|
| **design.md** | ✅ 保留全部内容 (现有设计仍然适用) |
| **implementation-guide.md** | ✅ 保留章节1-4 (美术、战斗、数值、性能) |
| **quick-reference.md** | ✅ 全部保留 |
| **PROJECT-SETUP.md** | ✅ 全部保留 |

### 4.2 哪些文档**需要微调**

| 文档 | 修改内容 | 工作量 | 优先级 |
|------|--------|-------|-------|
| **TECHNICAL-DECISIONS.md** | ADR-008 改为"混合架构" (不再纯端云) | 中 (2h) | P0 |
| **implementation-guide.md** | 第5章"社交系统"改为"服务端集成指南" | 中 (3h) | P0 |
| **LOCAL-SQLITE-ASSESSMENT.md** | 完全废弃此文档 (用本文档代替) | 0 | N/A |
| **ARCHITECTURE-MIGRATION-PLAN.md** | 完全废弃 (用本文档代替) | 0 | N/A |

### 4.3 新增文档

| 文档名 | 内容 | 优先级 |
|-------|------|-------|
| **HYBRID-ARCHITECTURE-ASSESSMENT.md** | ✅ 本文档 (替代前两个架构评估) | P0 |
| **SERVER-DEPLOYMENT-GUIDE.md** | 4核8G服务器部署与优化 | P1 |
| **DATA-SYNC-PROTOCOL.md** | 详细的网络同步协议定义 | P1 |

---

## 第五部分：服务端实现工作量估算

### 5.1 后端功能清单 (MVP版本)

```yaml
必须实现 (M1 - 2周):
  ① 用户登录认证
     - 微信openid获取
     - session管理
     预估: 4小时
  
  ② 排行榜系统
     - 接收玩家分数上报
     - Redis缓存排名
     - 定时计算排名 (5分钟一次)
     预估: 8小时
  
  ③ 救援数据交换
     - A设备上报救援信息
     - B设备查询救援任务
     - 验证并返还物品
     预估: 8小时
  
  ④ 热更新配置系统
     - 存储配置版本
     - 返回最新配置
     - 版本检查机制
     预估: 6小时
  
  ⑤ 数据持久化 (MySQL)
     - 用户账户表
     - 排行榜历史
     - 救援记录
     预估: 4小时
  
  小计: 30小时 (4-5天，假设1人全职开发)

可选实现 (M2 - 1周):
  ① 反作弊检测
     - 异常行为日志
     - 简单数值范围检查
     预估: 6小时
  
  ② 社交分享
     - 成绩分享链接
     - 社交卡片展示
     预估: 4小时
  
  ③ 游戏分析Dashboard
     - 实时用户统计
     - 排行榜可视化
     预估: 10小时
  
  小计: 20小时 (可选)
```

### 5.2 技术栈推荐 (for 4核8G)

```yaml
后端框架:
  推荐: Node.js + Express (或 Python Flask)
  原因: 轻量、快速迭代、内存占用少
  
数据库:
  主数据库: MySQL 5.7 (InnoDB)
  缓存层: Redis (排行榜、session缓存)
  
部署方式:
  ① Docker容器化 (便于扩展)
  ② PM2进程管理 (保证高可用)
  ③ Nginx反向代理 (负载均衡)
  
成本:
  阿里云轻量: 50元/月 (4核8G)
  域名: 10元/年
  SSL证书: 免费 (Let's Encrypt)
  CDN: 可选 (仅配置文件分发)
```

### 5.3 初期成本与收益

| 项目 | 成本 |
|------|------|
| **服务器** | 50元/月 = 600元/年 |
| **域名** | 10元/年 |
| **SSL证书** | 免费 |
| **后端开发** | 30小时 × 200元/小时 = 6000元 (一次性) |
| **运维** | <2小时/周 × 50元/小时 = 4000元/年 |
| **总计第1年** | ~10600元 |
| **往后每年** | ~4600元 |

**ROI**: 如果DAU > 100，这个投资是值得的。

---

## 第六部分：直言建议

### 6.1 这个方案的优势

```
✅ 游戏完全离线可玩 (无网络可以单机)
✅ 保留所有社交功能 (排行榜+救援)
✅ 低成本初期投入 (仅600元/年)
✅ 快速迭代能力 (热更新配置)
✅ 可扩展性 (日活>1000时可升级)
✅ 反作弊能力 (关键数据服务端校验)
```

### 6.2 这个方案的劣势

```
⚠️ 需要后端开发 (30小时初期投入)
⚠️ 需要运维管理 (2小时/周维护)
⚠️ 网络延迟 (5分钟更新一次排行榜)
⚠️ 容量上限 (日活>2000时需升级)
⚠️ 复杂度增加 (网络同步逻辑)
```

### 6.3 我的核心建议

> **这是目前最平衡的方案**，强烈推荐执行。

理由:
1. 保留了原设计的所有核心功能
2. 成本足够低 (600元/年)
3. 不需要复杂的后端架构
4. 完全离线可玩，提高容错性
5. 可以根据用户反馈逐步优化

---

## 第七部分：立即行动计划

### Phase 1: 文档更新 (1天)
- [ ] 重写 TECHNICAL-DECISIONS.md ADR-008
- [ ] 更新 implementation-guide.md 第5章
- [ ] 创建 DATA-SYNC-PROTOCOL.md (网络协议定义)
- [ ] 创建 SERVER-DEPLOYMENT-GUIDE.md

### Phase 2: 前端实现 (2周)
- [ ] 实现本地SQLite存储
- [ ] 实现NetworkManager (带重连机制)
- [ ] 实现同步队列系统
- [ ] 离线测试

### Phase 3: 后端实现 (1周)
- [ ] 搭建服务器与数据库
- [ ] 实现登录认证
- [ ] 实现排行榜系统
- [ ] 实现救援数据交换
- [ ] 实现热更新接口

### Phase 4: 集成与测试 (3天)
- [ ] 前后端联调
- [ ] 网络断线模拟测试
- [ ] 排行榜功能测试
- [ ] 救援机制测试

### Phase 5: 上线前准备 (3天)
- [ ] 微信审核准备
- [ ] 性能优化
- [ ] 监控与告警配置
- [ ] 文档补充

**总工作量**: 3周 (1个前端 + 1个后端)

---

## 附录：vs 前两个方案的对比

| 维度 | 纯本地SQLite | 本方案(混合) | 完整云方案 |
|------|-----------|-----------|---------|
| **社交功能** | ❌ 无 | ✅ 完整 | ✅ 完整 |
| **排行榜** | ❌ 无 | ✅ 有 | ✅ 有 |
| **救援机制** | ❌ 无 | ✅ 有 | ✅ 有 |
| **离线游玩** | ✅ 完全离线 | ✅ 完全离线 | ❌ 需在线 |
| **反作弊** | ❌ 无 | ⚠️ 简化 | ✅ 完整 |
| **初期成本** | 0 | 600元/年 | 2000+元/年 |
| **开发工作** | 20h | 50h | 200h |
| **推荐指数** | ⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |

---

**核心结论**:
> 4核8G服务器 + 本地SQLite 是这个项目最合适的架构。  
> 它在**成本、功能、复杂度**之间达到最好的平衡。
