# Prometheus 记录规则
# 用于预计算常用指标，加快查询性能

groups:
  - name: "light_heart_recording_rules"
    interval: 30s
    rules:
      
      # ============ HTTP 指标 ============
      
      - record: "http:request:rate5m"
        expr: "rate(http_request_total[5m])"
        
      - record: "http:error:rate5m"
        expr: "rate(http_errors_total[5m])"
        
      - record: "http:error_ratio:5m"
        expr: "http:error:rate5m / http:request:rate5m"
        
      - record: "http:request:p95"
        expr: "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))"
        
      - record: "http:request:p99"
        expr: "histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m]))"
      
      # ============ 数据库指标 ============
      
      - record: "db:query:rate5m"
        expr: "rate(db_query_total[5m])"
        
      - record: "db:query:duration:p95"
        expr: "histogram_quantile(0.95, rate(db_query_duration_seconds_bucket[5m]))"
        
      - record: "db:query:duration:p99"
        expr: "histogram_quantile(0.99, rate(db_query_duration_seconds_bucket[5m]))"
        
      - record: "db:query:slow:5m"
        expr: "rate(db_query_duration_seconds_bucket{le=\"0.5\"}[5m])"
      
      # ============ 缓存指标 ============
      
      - record: "cache:hit:rate5m"
        expr: "rate(cache_hits_total[5m])"
        
      - record: "cache:miss:rate5m"
        expr: "rate(cache_misses_total[5m])"
        
      - record: "cache:hit:ratio"
        expr: "cache:hit:rate5m / (cache:hit:rate5m + cache:miss:rate5m)"
      
      # ============ 游戏指标 ============
      
      - record: "game:battle:win:rate1h"
        expr: "rate(game_battles_total{result=\"win\"}[1h]) / rate(game_battles_total[1h])"
        
      - record: "game:score:rate5m"
        expr: "rate(game_score_submitted_total[5m])"
        
      - record: "game:battle:rate5m"
        expr: "rate(game_battles_total[5m])"
      
      # ============ 系统指标 ============
      
      - record: "system:memory:percent"
        expr: "process_memory_bytes / node_memory_MemTotal_bytes * 100"
        
      - record: "system:uptime:hours"
        expr: "process_uptime_seconds / 3600"
      
      # ============ 聚合指标 ============
      
      - record: "app:health:score"
        expr: |
          (
            (1 - http:error_ratio:5m) * 40 +
            min(cache:hit:ratio, 1) * 30 +
            (1 - (db:query:duration:p95 / 1)) * 20 +
            (game_player_online / 10000) * 10
          )
